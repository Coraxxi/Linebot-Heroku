# 05-1 連接DB-程式概略

```
 |__ <app>
       |__ index.js      (修改)
       |__ package.json  (修改)
       |
       |__ <node_modules> 
```

## 1. 修改package.json

#### 增加:
```
"pg": "^7.4.3"
```

#### package.json
``` json
{
    "name": "myApp",
    "version": "1.0.0",
    "description": "my Linebot application",
    "main": "index.js",
    "scripts": {
        "start": "node ."
    },
    "author": "tomlin",
    "license": "ISC",
    "dependencies": {
        "express": "^4.16.3",
        "linebot": "^1.4.1",
        "pg": "^7.4.3"
    }
}
```

## 2. 修改index.js

```
//=====================================================
// 載入必要的模組
//=====================================================
const { Client } = require('pg');

.
.
.

//=====================================================
// 自己的資料庫連結位址(在Heroku平台中查看)
//=====================================================
var pgConn = 'postgres://(自己的資料庫連結位址)';

.
.
.

//=====================================================
// 機器人某個事件的處理
//=====================================================
bot.on('某個事件, 如message', function(...) {
    .
    .
    .        
    //---------------------------------
    //(1)建立資料庫連線           
    //---------------------------------
    var client = new Client({
        connectionString: pgConn,
        ssl: true,
    })
			
    client.connect();
    //---------------------------------

			
    //---------------------------------------------			
    //(2)取存DB資料
    //   (資料庫欄位名稱不使用駝峰命名, 否則可能出錯)
    //---------------------------------------------			
    client.query("SQL命令... $1, $2, $3,...", [參數1, 參數2, 參數3], (err, results) => {    		
        //如果有錯
        if (err) {             
            client.end(); //關閉連線
            return;
        }
				
        //取回的資料
        for(var i; i<results.length; i++){				
            var 變數名稱 = results.rows[i].欄位名稱;
        }

        //(3)關閉連線
        client.end();
    }); 
    //---------------------------------------------	            
    .
    .
    .			
});
//=====================================================
```
